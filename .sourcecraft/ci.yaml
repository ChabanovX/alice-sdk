on:
  pull_request: 
    - workflows: [backend-tests]
      filter:
        paths: "backend/**"
    - workflows: [flutter-tests]
      filter:
        paths: "flutter/**"

workflows:
  backend-tests:
    tasks:
      - name: backend-tests-task
        cubes:
          - name: build-and-test
            image: ghcr.io/userver-framework/ubuntu-22.04-userver:latest
            script:
              - cd $SOURCECRAFT_WORKSPACE
              - git checkout $SOURCECRAFT_COMMIT_SHA
              - groupadd -g 1000 myuser
              - useradd -u 1000 -g 1000 -m myuser
              - chown 1000:1000 ./**
              - cd backend
              - sudo -u myuser make test-release
              - make dist-clean
              - apt update
              - apt install -y clang-tidy
              - cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON .
              - sed -i 's/-static-libasan//g' compile_commands.json
              - clang-tidy src/*.cpp -checks=google-*,clang-analyzer-*
  
  flutter-tests:
    tasks:
      - name: flutter-tests-task
        cubes:
          - name: install-and-test
            image: ghcr.io/cirruslabs/flutter:3.32.7
            script:
              - cd $SOURCECRAFT_WORKSPACE
              - cd mobile
              - flutter --version
              - flutter pub get
              - flutter test
              - flutter analyze